# modules/chatbot_module.R - Module Chatbot Ã‰lectoral IA

# Interface utilisateur du chatbot
chatbotUI <- function(id) {
  ns <- NS(id)
  
  div(id = ns("chatbot_container"), class = "chatbot-container",
    # Bouton pour ouvrir/fermer le chatbot
    div(id = ns("chatbot_toggle"), class = "chatbot-toggle",
      icon("comments", class = "fa-lg"),
      span("Assistant IA", class = "chatbot-label")
    ),
    
    # Interface du chatbot
    div(id = ns("chatbot_interface"), class = "chatbot-interface", style = "display: none;",
      # En-tÃªte du chatbot
      div(class = "chatbot-header",
        div(class = "chatbot-title",
          icon("robot", class = "me-2"),
          "Assistant Ã‰lectoral IA"
        ),
        div(class = "chatbot-status online",
          icon("circle", class = "fa-xs me-1"),
          "En ligne"
        ),
        div(id = ns("chatbot_close"), class = "chatbot-close",
          icon("times")
        )
      ),
      
      # Zone de conversation
      div(id = ns("chatbot_messages"), class = "chatbot-messages",
        div(class = "message bot-message",
          div(class = "message-avatar",
            icon("robot")
          ),
          div(class = "message-content",
            "ðŸ‘‹ Bonjour ! Je suis votre assistant Ã©lectoral IA. Comment puis-je vous aider aujourd'hui ?",
            br(),
            br(),
            "Vous pouvez me poser des questions sur :",
            br(),
            "â€¢ Les candidats et leurs programmes",
            br(),
            "â€¢ La procÃ©dure de vote",
            br(),
            "â€¢ Les rÃ©sultats et statistiques",
            br(),
            "â€¢ L'AES et ses missions"
          ),
          div(class = "message-time",
            format(Sys.time(), "%H:%M")
          )
        )
      ),
      
      # Zone de saisie
      div(class = "chatbot-input-area",
        div(class = "input-group",
          textInput(ns("message_input"), 
                   label = NULL,
                   placeholder = "Tapez votre question ici...",
                   width = "100%"),
          div(class = "input-group-append",
            actionButton(ns("send_message"), "",
                        icon = icon("paper-plane"),
                        class = "btn btn-primary send-btn")
          )
        ),
        div(class = "quick-actions",
          actionButton(ns("btn_candidats"), "Candidats", class = "btn btn-sm btn-outline-primary quick-btn"),
          actionButton(ns("btn_vote"), "Comment voter", class = "btn btn-sm btn-outline-primary quick-btn"),
          actionButton(ns("btn_resultats"), "RÃ©sultats", class = "btn btn-sm btn-outline-primary quick-btn")
        )
      ),
      
      # Zone d'affichage dynamique pour les messages R
      uiOutput(ns("chatbot_r_messages"))
    ),
    
    # Styles CSS
    tags$style(HTML("
      /* Bouton toggle du chatbot */
      .chatbot-toggle {
        position: fixed;
        bottom: 120px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 15px 20px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
        z-index: 1024;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        user-select: none;
      }
      
      .chatbot-toggle:hover {
        background: linear-gradient(135deg, #20c997, #17a2b8);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
      }
      
      .chatbot-label {
        font-size: 0.85rem;
        white-space: nowrap;
      }
      
      /* Interface du chatbot */
      .chatbot-interface {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 1030;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease-out;
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      
      /* En-tÃªte du chatbot */
      .chatbot-header {
        background: linear-gradient(135deg, #3f51b5, #303f9f);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      
      .chatbot-title {
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
      }
      
      .chatbot-status {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
      }
      
      .chatbot-status.online {
        color: #4caf50;
      }
      
      .chatbot-close {
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.2s;
      }
      
      .chatbot-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      
      /* Zone de messages */
      .chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .message {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        max-width: 90%;
      }
      
      .bot-message {
        align-self: flex-start;
      }
      
      .user-message {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      
      .message-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3f51b5, #303f9f);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        flex-shrink: 0;
      }
      
      .user-message .message-avatar {
        background: linear-gradient(135deg, #28a745, #20c997);
      }
      
      .message-content {
        background: white;
        padding: 12px 15px;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        font-size: 0.9rem;
        line-height: 1.4;
        position: relative;
      }
      
      .user-message .message-content {
        background: linear-gradient(135deg, #3f51b5, #303f9f);
        color: white;
      }
      
      .message-time {
        font-size: 0.7rem;
        color: #666;
        margin-top: 5px;
        text-align: center;
      }
      
      /* Zone de saisie */
      .chatbot-input-area {
        padding: 15px 20px;
        background: white;
        border-top: 1px solid #e9ecef;
      }
      
      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .chatbot-input-area input {
        border: 2px solid #e9ecef;
        border-radius: 25px;
        padding: 10px 15px;
        font-size: 0.9rem;
        transition: border-color 0.2s;
      }
      
      .chatbot-input-area input:focus {
        border-color: #3f51b5;
        box-shadow: none;
      }
      
      .send-btn {
        border-radius: 50%;
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #3f51b5, #303f9f);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .send-btn:hover {
        background: linear-gradient(135deg, #303f9f, #1a237e);
        transform: scale(1.05);
      }
      
      /* Actions rapides */
      .quick-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .quick-btn {
        font-size: 0.75rem;
        padding: 5px 12px;
        border-radius: 15px;
        border: 1px solid #3f51b5;
        color: #3f51b5;
        background: transparent;
        transition: all 0.2s;
      }
      
      .quick-btn:hover {
        background: #3f51b5;
        color: white;
        transform: translateY(-2px);
      }
      
      /* Version mobile */
      @media (max-width: 768px) {
        .chatbot-toggle {
          bottom: 100px;
          right: 15px;
          padding: 12px 16px;
        }
        
        .chatbot-interface {
          width: calc(100vw - 20px);
          height: 70vh;
          right: 10px;
          bottom: 10px;
        }
        
        .chatbot-label {
          display: none;
        }
      }
    ")),
    
    # JavaScript pour l'interaction
    tags$script(HTML(paste0("
      $(document).ready(function() {
        // Base de connaissances du chatbot
        var knowledgeBase = {
          candidats: {
            keywords: ['candidat', 'postulant', 'qui', 'prÃ©sente', 'liste'],
            responses: [
              'Voici les candidats pour les diffÃ©rents postes de l\'AES. Pour voir tous les candidats, consultez l\'onglet \"Candidats au scrutin AES\".',
              'Chaque candidat a un profil dÃ©taillÃ© avec ses propositions et son expÃ©rience. Vous pouvez filtrer les candidats par poste.',
              'Les candidats se prÃ©sentent pour diffÃ©rents postes : PrÃ©sident, Vice-PrÃ©sident, SecrÃ©taire GÃ©nÃ©ral, etc.'
            ]
          },
          vote: {
            keywords: ['voter', 'comment', 'procÃ©dure', 'vote', 'bulletin'],
            responses: [
              'Pour voter, rendez-vous dans l\'onglet \"Votes AES\" aprÃ¨s vous Ãªtre authentifiÃ©.',
              'Le vote est anonyme et sÃ©curisÃ©. Vous ne pouvez voter qu\'une seule fois par poste.',
              'SÃ©lectionnez votre candidat prÃ©fÃ©rÃ© et confirmez votre choix. Votre vote est immÃ©diatement enregistrÃ©.'
            ]
          },
          resultats: {
            keywords: ['rÃ©sultat', 'gagnant', 'vainqueur', 'score', 'dÃ©pouillement'],
            responses: [
              'Les rÃ©sultats sont disponibles en temps rÃ©el dans l\'onglet \"RÃ©sultats\".',
              'Le dÃ©pouillement est automatique et transparent. Les statistiques dÃ©taillÃ©es sont dans l\'onglet \"Statistiques\".',
              'Les rÃ©sultats finaux seront annoncÃ©s officiellement Ã  la fin du scrutin.'
            ]
          },
          aes: {
            keywords: ['aes', 'amicale', 'association', 'organisation'],
            responses: [
              'L\'AES (Amicale des Ã‰tudiants et Stagiaires) reprÃ©sente tous les Ã©tudiants de l\'ENSAE.',
              'CrÃ©Ã©e en 2009, l\'AES promeut la solidaritÃ© et l\'entraide entre Ã©tudiants.',
              'L\'AES organise des activitÃ©s culturelles, sportives et acadÃ©miques.'
            ]
          },
          aide: {
            keywords: ['aide', 'help', 'assistance', 'problÃ¨me'],
            responses: [
              'Je suis votre assistant Ã©lectoral IA. Posez-moi vos questions !',
              'Vous pouvez me demander des informations sur les candidats, le vote, ou les rÃ©sultats.',
              'Tapez \"candidats\", \"vote\", \"rÃ©sultats\" ou \"aide\" pour des informations spÃ©cifiques.'
            ]
          }
        };
        
        var chatbotOpen = false;
        
        // Ouvrir/fermer le chatbot
        $('#", ns("chatbot_toggle"), "').click(function() {
          var interface = $('#", ns("chatbot_interface"), "');
          if (chatbotOpen) {
            interface.hide();
            chatbotOpen = false;
          } else {
            interface.show();
            chatbotOpen = true;
            var messages = $('#", ns("chatbot_messages"), "');
            messages.scrollTop(messages[0].scrollHeight);
          }
        });
        
        // Fermer le chatbot
        $('#", ns("chatbot_close"), "').click(function() {
          $('#", ns("chatbot_interface"), "').hide();
          chatbotOpen = false;
        });
        
        // Fonction pour ajouter un message
        function addMessage(content, isUser = false) {
          var messagesContainer = $('#", ns("chatbot_messages"), "');
          var time = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
          var messageClass = isUser ? 'user-message' : 'bot-message';
          var avatarIcon = isUser ? 'fa-user' : 'fa-robot';
          
          var messageHtml = 
            '<div class=\"message ' + messageClass + '\">' +
              '<div class=\"message-avatar\">' +
                '<i class=\"fa ' + avatarIcon + '\"></i>' +
              '</div>' +
              '<div class=\"message-content\">' +
                content +
              '</div>' +
              '<div class=\"message-time\">' +
                time +
              '</div>' +
            '</div>';
          
          messagesContainer.append(messageHtml);
          messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
        }
        
        // Fonction IA pour gÃ©nÃ©rer une rÃ©ponse
        function generateAIResponse(userMessage) {
          var message = userMessage.toLowerCase();
          var bestMatch = null;
          var maxScore = 0;
          
          Object.keys(knowledgeBase).forEach(function(category) {
            var keywords = knowledgeBase[category].keywords;
            var score = 0;
            
            keywords.forEach(function(keyword) {
              if (message.includes(keyword)) {
                score += 1;
              }
            });
            
            if (score > maxScore) {
              maxScore = score;
              bestMatch = category;
            }
          });
          
          if (bestMatch && maxScore > 0) {
            var responses = knowledgeBase[bestMatch].responses;
            return responses[Math.floor(Math.random() * responses.length)];
          } else {
            var defaultResponses = [
              'Je ne suis pas sÃ»r de comprendre votre question. Pouvez-vous la reformuler ?',
              'Pouvez-vous prÃ©ciser votre question ? Je peux vous aider sur les candidats, le vote, ou les rÃ©sultats.',
              'Tapez \"aide\" pour voir ce que je peux faire pour vous.'
            ];
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
          }
        }
        
        // Envoyer un message
        function sendMessage() {
          var input = $('#", ns("message_input"), "');
          var message = input.val().trim();
          
          if (message) {
            addMessage(message, true);
            input.val('');
            
            setTimeout(function() {
              var response = generateAIResponse(message);
              addMessage(response, false);
            }, 800 + Math.random() * 1200);
          }
        }
        
        // Ã‰vÃ©nements
        $('#", ns("send_message"), "').click(sendMessage);
        
        $('#", ns("message_input"), "').keypress(function(e) {
          if (e.which == 13) {
            sendMessage();
          }
        });
        
        // Boutons d'action rapide
        $('#", ns("btn_candidats"), "').click(function() {
          addMessage('Candidats', true);
          setTimeout(function() {
            addMessage(generateAIResponse('candidats'), false);
          }, 500);
        });
        
        $('#", ns("btn_vote"), "').click(function() {
          addMessage('Comment voter ?', true);
          setTimeout(function() {
            addMessage(generateAIResponse('comment voter'), false);
          }, 500);
        });
        
        $('#", ns("btn_resultats"), "').click(function() {
          addMessage('RÃ©sultats', true);
          setTimeout(function() {
            addMessage(generateAIResponse('rÃ©sultats'), false);
          }, 500);
        });
      });
    ")))
  )
}

# Serveur du chatbot avec fonctionnalitÃ©s innovantes
chatbotServer <- function(id) {
  moduleServer(id, function(input, output, session) {
    ns <- session$ns

    # Historique des messages (pour affichage)
    messages <- reactiveVal(list(
      list(sender = "bot", text = "ðŸ‘‹ Bonjour ! Je suis votre assistant Ã©lectoral IA. Comment puis-je vous aider aujourd'hui ?<br><br><b>Vous pouvez me demander :</b><br>â€¢ Les candidats et leurs programmes<br>â€¢ La procÃ©dure de vote<br>â€¢ Les rÃ©sultats et statistiques<br>â€¢ L'AES et ses missions<br><button id='btn_discover' class='btn btn-sm btn-outline-success mt-2'>DÃ©couvrir la plateforme</button>")
    ))

    # Base FAQ dynamique (en mÃ©moire)
    faq_db <- reactiveVal(list(
      "comment voter" = "Pour voter, allez dans l'onglet <b>Votes AES</b> et suivez les instructions.",
      "candidats" = "La liste des candidats est disponible dans l'onglet <b>Candidats au scrutin AES</b>.",
      "statut" = "<a href='Documentation/statut_aes.pdf' target='_blank'>TÃ©lÃ©charger le statut de l'AES</a>",
      "rÃ¨glement" = "<a href='Documentation/Reglement_interieur_ENSAE_janvier_2021.pdf' target='_blank'>TÃ©lÃ©charger le rÃ¨glement intÃ©rieur</a>"
    ))

    # Fonction pour ajouter un message
    add_message <- function(sender, text) {
      old <- messages()
      messages(append(old, list(list(sender = sender, text = text))))
    }

    # Affichage dynamique des messages
    output$chatbot_r_messages <- renderUI({
      lapply(messages(), function(msg) {
        div(class = if (msg$sender == "user") "message user-message" else "message bot-message",
            div(class = "message-avatar", icon(if (msg$sender == "user") "user" else "robot")),
            div(class = "message-content", HTML(msg$text)),
            div(class = "message-time", format(Sys.time(), "%H:%M"))
        )
      })
    })

    # Fonction de recherche intelligente et FAQ
    get_bot_response <- function(user_text) {
      txt <- tolower(user_text)
      # Recherche intelligente dans la FAQ
      for (q in names(faq_db())) {
        if (grepl(q, txt, fixed = TRUE)) return(faq_db()[[q]])
      }
      # Recherche de mots-clÃ©s pour les documents
      if (grepl("programme", txt)) {
        return("Pour voir les programmes des candidats, allez dans l'onglet <b>Candidats au scrutin AES</b>.")
      }
      # Mode dÃ©couverte
      if (grepl("dÃ©couvrir", txt) || grepl("tour", txt)) {
        return(paste0(
          "<b>Tour guidÃ© de la plateforme :</b><br>",
          "1. <b>Accueil</b> : Retrouvez les documents utiles et les annonces importantes.<br>",
          "2. <b>Candidats</b> : Consultez la liste des candidats et leurs programmes.<br>",
          "3. <b>Votes AES</b> : Participez au vote en toute sÃ©curitÃ©.<br>",
          "4. <b>RÃ©sultats</b> : Suivez les rÃ©sultats en temps rÃ©el.<br>",
          "5. <b>Statistiques</b> : Analysez la participation et les tendances.<br>"
        ))
      }
      # Si rien trouvÃ©
      return("Je n'ai pas encore la rÃ©ponse Ã  cette question. Tapez 'aide' pour voir ce que je peux faire, ou posez une question sur les Ã©lections, les candidats, le vote...")
    }

    # Gestion de l'envoi de message utilisateur (Ã  adapter selon ton UI)
    observeEvent(input$message_input, {
      req(input$message_input)
      user_msg <- input$message_input
      add_message("user", user_msg)
      # RÃ©ponse du bot
      bot_msg <- get_bot_response(user_msg)
      add_message("bot", bot_msg)
      updateTextInput(session, "message_input", value = "")
    }, ignoreInit = TRUE)

    # Gestion du bouton DÃ©couvrir la plateforme (si cliquÃ©)
    observe({
      session$sendCustomMessage('bindDiscoverBtn', list(ns = ns(NULL)))
    })
    observeEvent(input$btn_discover, {
      add_message("bot", get_bot_response("dÃ©couvrir"))
    })
  })
} 